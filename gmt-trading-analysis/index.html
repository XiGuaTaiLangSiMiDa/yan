<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMT/USDT Analysis</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .analysis-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .analysis-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .analysis-box h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .price-level {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .price-level:last-child {
            border-bottom: none;
        }
        .volume-bar {
            height: 4px;
            background: #e0e0e0;
            margin-top: 5px;
            border-radius: 2px;
        }
        .volume-bar-fill {
            height: 100%;
            background: #4CAF50;
            border-radius: 2px;
        }
        .support .volume-bar-fill {
            background: #4CAF50;
        }
        .resistance .volume-bar-fill {
            background: #f44336;
        }
        #lastUpdate {
            text-align: right;
            color: #666;
            font-size: 0.9em;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chart-container">
            <!-- TradingView Widget BEGIN -->
            <div class="tradingview-widget-container">
                <div id="tradingview_chart"></div>
                <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
                <script type="text/javascript">
                new TradingView.widget({
                    "width": "100%",
                    "height": 500,
                    "symbol": "BINANCE:GMTUSDT",
                    "interval": "240",
                    "timezone": "Asia/Shanghai",
                    "theme": "light",
                    "style": "1",
                    "locale": "zh_CN",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "hide_side_toolbar": false,
                    "allow_symbol_change": false,
                    "container_id": "tradingview_chart",
                    "studies": [
                        "RSI@tv-basicstudies"
                    ]
                });
                </script>
            </div>
            <!-- TradingView Widget END -->
        </div>

        <div class="analysis-container">
            <div class="analysis-box">
                <h3>历史价格分析</h3>
                <div id="historicalLevels"></div>
            </div>
            <div class="analysis-box">
                <h3>订单簿深度分析</h3>
                <div id="orderBookLevels"></div>
            </div>
            <div class="analysis-box">
                <h3>技术指标</h3>
                <div id="technicalIndicators"></div>
            </div>
        </div>
        <div id="lastUpdate"></div>
    </div>

    <script>
        // 更新历史价格分析
        function updateHistoricalLevels(data) {
            const container = document.getElementById('historicalLevels');
            const maxVolume = Math.max(...data.map(item => item.volume));
            
            const html = data.map(level => `
                <div class="price-level ${level.price < window.currentPrice ? 'support' : 'resistance'}">
                    <span>${level.price} USDT</span>
                    <span>${Math.round(level.volume).toLocaleString()} 成交量</span>
                    <div class="volume-bar">
                        <div class="volume-bar-fill" style="width: ${(level.volume / maxVolume * 100)}%"></div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // 更新订单簿深度
        function updateOrderBook(data) {
            const container = document.getElementById('orderBookLevels');
            const maxVolume = Math.max(...data.map(item => item.volume));
            
            const html = data.map(level => `
                <div class="price-level ${level.type}">
                    <span>${level.price} USDT</span>
                    <span>${Math.round(level.volume).toLocaleString()} 挂单量</span>
                    <div class="volume-bar">
                        <div class="volume-bar-fill" style="width: ${(level.volume / maxVolume * 100)}%"></div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // 更新技术指标
        function updateTechnicalIndicators(data) {
            const container = document.getElementById('technicalIndicators');
            container.innerHTML = `
                <div class="price-level">
                    <span>当前价格</span>
                    <span>${data.currentPrice} USDT</span>
                </div>
                <div class="price-level">
                    <span>RSI(14)</span>
                    <span>${data.rsi.toFixed(2)}</span>
                </div>
                <div class="price-level">
                    <span>建议操作区间</span>
                    <span>${data.tradingRange.min} - ${data.tradingRange.max}</span>
                </div>
            `;
        }

        // 更新时间
        function updateTimestamp() {
            const container = document.getElementById('lastUpdate');
            container.textContent = `最后更新时间: ${new Date().toLocaleString()}`;
        }

        // 模拟数据更新
        async function fetchAndUpdateData() {
            try {
                const response = await fetch('/api/analysis');
                const data = await response.json();
                window.currentPrice = data.currentPrice;
                
                updateHistoricalLevels(data.historicalLevels);
                updateOrderBook(data.orderBookLevels);
                updateTechnicalIndicators({
                    currentPrice: data.currentPrice,
                    rsi: data.rsi,
                    tradingRange: data.tradingRange
                });
                updateTimestamp();
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // 每60秒更新一次数据
        setInterval(fetchAndUpdateData, 60000);
        fetchAndUpdateData();
    </script>
</body>
</html>
